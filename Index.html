<!DOCTYPE html>
<html>
<head>
    <script src="https://aframe.io/releases/0.5.0/aframe.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>

    <script src="https://aframe.io/releases/0.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-bubblechart-component/dist/aframe-bubblechart-component.min.js"></script>



</head>
<body>


    <a-scene>

        <a-entity id="menu-group" visible="true">

            <a-box id="b1" color="green" position="0 7 0" depth="0.1" height="1" width="3.3" onclick="view('b1')">
                <a-text value="About the center" color="black" position="1 -0.55 1" width="8" align="center"></a-text>
            </a-box>

            <a-box id="b2" color="green" position="4 7 0" depth="0.1" height="1" width="3.3" onclick="view('b2')">
                <a-text value="Sectors" color="black" position="0.5 -0.55 1" width="8" align="center"></a-text>
            </a-box>

            <a-box id="b3" color="green" position="8 7 0" depth="0.1" height="1" width="3.3" onclick="view('b3')">
                <a-text value="Activities" color="black" position="0 -0.55 1" width="8" align="center"></a-text>
            </a-box>

            <a-box id="b4" color="green" position="12 7 0" depth="0.1" height="1" width="3.3" onclick="view('b4')">
                <a-text value="Pollution Example" color="black" position="-0.5 -0.55 1" width="8" align="center"></a-text>
            </a-box>
        </a-entity>

        <a-entity id="sheet1-T" visible="true">
            <a-circle id=#female color="grey" position="16 7 0" scale=".3 .3 .3" onclick="visualize_bars('F')">
                <a-text value="female" color="black" position="3.5 0 0" width="35" align="center"></a-text>
            </a-circle>

            <a-circle id=#male color="grey" position="16 6 0" scale=".3 .3 .3" onclick="visualize_bars('M')">
                <a-text value="male" color="black" position="3 0 0" width="35" align="center"></a-text>
            </a-circle>

            <a-circle id=#all color="grey" position="16 5 0" scale=".3 .3 .3" onclick="visualize_bars()">
                <a-text value="all" color="black" position="3 0 0" width="35" align="center"></a-text>
            </a-circle>
        </a-entity>
        <a-entity id="sheet1-B" visible="true"></a-entity>
        <a-entity id="sheet2" visible="false">
            <!--<a-ring color="grey" position="16 7 0" scale=".2 .2 .2" radius-inner="1" radius-outer="2"></a-ring>-->



        </a-entity>
        <a-entity id="sheet3" visible="false">

            <a-entity bubblechart="foo: bar"></a-entity>

        </a-entity>
        <a-entity id="sheet4" visible="false"></a-entity>

        <a-entity position="8 2 12" rotation="0 0 0">
            <a-entity camera look-controls wasd-controls>
                <a-entity cursor="fuse: true; fuseTimeout: 500"
                          position="0 0 -2"
                          geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.027"
                          material="color: black; shader: flat"
  			</a-entity>
            </a-entity>
        </a-entity>
        <a-entity light="type: point; color: 'white'; intensity: 0.5" position="20 40 20"></a-entity>
        <a-entity light="type: point; color: 'white'; intensity: 0.5" position="-20 40 20"></a-entity>
        <a-sky color="#c8f8e0"></a-sky>
    </a-scene>

    <script>
        // default alpha for bars
        var alpha = 0.6

        var data2 = [{ "timestamp": "Thu Sep 20 06:56:33 2018", "gender": "F", "nationality": "Pakistani", "age": 32, "Costruction hotspot": 100.0, "Coating hotspot": 66.6666666667, "Food and beverage hotspot": 33.3333333333 }, { "timestamp": "Fri Sep 21 22:13:27 2018", "gender": "F", "nationality": "Saudi", "age": 22, "Costruction hotspot": 75.0, "Coating hotspot": 50.0, "Food and beverage hotspot": 25.0 }, { "timestamp": "Sun Sep 23 00:39:37 2018", "gender": "M", "nationality": "Saudi", "age": 12, "Costruction hotspot": 100.0, "Coating hotspot": 50.0, "Food and beverage hotspot": 25.0 }]
        //var data3 = {"timestamp":{"0":"Thu Sep 20 06:56:33 2018","1":"Fri Sep 21 22:13:27 2018","2":"Sun Sep 23 00:39:37 2018"},"gender":{"0":"F","1":"F","2":"M"},"nationality":{"0":"Pakistani","1":"Saudi","2":"Saudi"},"age":{"0":32,"1":22,"2":12},"Costruction hotspot":{"0":100.0,"1":75.0,"2":100.0},"Coating hotspot":{"0":66.6666666667,"1":50.0,"2":50.0},"Food and beverage hotspot":{"0":33.3333333333,"1":25.0,"2":25.0}};

        

        /*
        list = get_average_score(data2)
        hotspots = list[0]
        avg_scores = list[1]
        user_scores = list[2]
        */



        function hide() {

            d3.select("a-scene").select("#sheet1-T").attr({ visible: "false" })
            d3.select("a-scene").select("#sheet1-B").attr({ visible: "false" })
            d3.select("a-scene").select("#sheet2").attr({ visible: "false" })
            d3.select("a-scene").select("#sheet3").attr({ visible: "false" })
            d3.select("a-scene").select("#sheet4").attr({ visible: "false" })

        }

        function view(button) {

            if (button == 'b1') {
                hide()
                d3.select("a-scene").select("#sheet1-T").attr({ visible: "true" })
                d3.select("a-scene").select("#sheet1-B").attr({ visible: "true" })
            } else if (button == 'b2') {
                hide()
                d3.select("a-scene").select("#sheet2").attr({ visible: "true" })
            } else if (button == 'b3') {
                hide()
                d3.select("a-scene").select("#sheet3").attr({ visible: "true" })
            } else if (button == 'b4') {
                hide()
                d3.select("a-scene").select("#sheet4").attr({ visible: "true" })
            }
        }

 
        function get_average_score(data_arr) {
            var current_user = data_arr.slice(-1)[0]

            hotspot_names = Object.getOwnPropertyNames(data_arr[0])
            demographics = ["timestamp", "gender", "nationality", "age"]

            var obj = {};
            data_arr.forEach(function (el) {

                hotspot_names.forEach(function (hn) {



                    if (!(demographics.includes(hn))) {
                        key = hn
                        console.log(hn)
                        obj[key] = obj[key] || { count: 0, total: 0, avg: 0 };
                        obj[key].count++;
                        obj[key].total += el[hn];
                        obj[key].avg = obj[key].total / obj[key].count;

                    }
                });

            });


            var hotspot_list = []
            var score_average = []
            var user_scores= []

            for (var key in obj) {
                //var hotspot = key.replace("hotspot", "")

                hotspot_list.push(key.replace("hotspot", ""))
                score_average.push(Math.round(obj[key].avg))
                user_scores.push(Math.round(current_user[key]))
            }
            return [hotspot_list, score_average,user_scores];
        }


        function gender_filter(option=0) {

        return data2.filter(function (d) { return d.gender == option; })   
        }

        function visualize_bars(filter = 0) {
            data=data2
            if (!(filter === 0)) {
                console.log(filter)
                data = gender_filter(filter)
                console.log(data)
            }

            list = get_average_score(data)
            hotspots = list[0]
            avg_scores = list[1]
            user_scores = list[2]


            // we use d3's enter/update/exit pattern to draw and bind our dom elements
            //filling the first sheet with bar graph
            var sheet1_T = d3.select("a-scene").select("#sheet1-T")
            var sheet1_B = d3.select("a-scene").select("#sheet1-B")



            //__________________________User bars__________________________

            // we scale the height of our bars using d3's linear scale
            var hscale = d3.scale.linear()
                .domain([0, d3.max(user_scores)])
                .range([0, 3])

            var user_bars = sheet1_T.selectAll("a-box.bar").data(user_scores)
            user_bars.enter().append("a-box").classed("bar", true)

            $(".bar").append("<a-text> </a-text>");
            // we set attributes on our cubes to determine how they are rendered
            user_bars.attr({
                position: function (d, i) {
                    var x = i * .75
                    var y = -(hscale(d) / 2);
                    var z = 1
                    return x + " " + y + " " + z
                },
                width: function (d) { return 0.5 },
                depth: function (d) { return 0.5 },
                height: function (d) { return hscale(d) },
                opacity: alpha,
                color: 'blue'
            })
                .on("click", function (d, i) {
                    console.log("click", i, d)
                })
                .on("mouseenter", function (d, i) {
                    // this event gets fired continuously as long as the cursor
                    // is over the element. we only want trigger our animation the first time
                    if (this.hovering) return;
                    console.log("hover", i, d)
                    this.hovering = true;
                    d3.select(this).transition().duration(10)
                        .attr({
                            metalness: 0.8,
                            opacity: .9
                        })
                    d3.select(this).select("a-text")
                        .attr({
                            'color': 'hsla(240, 100%, 25%, 0.6)',
                            'align': 'center',
                            'position': '0 ' + -(hscale(d) / 2 + .6) + ' 0',
                            'scale': '1 1 1',
                            'value': hotspots[i] + ', ' + d
                        })
                })
                .on("mouseleave", function (d, i) {
                    console.log("leave", i, d)
                    this.hovering = false;
                    d3.select(this).transition().duration(500)
                        .attr({
                            metalness: 0,
                            opacity: alpha
                        })
                    d3.select(this).select("a-text")
                        .attr({
                            'color': 'blue',
                            'align': 'center',
                            'position': '0 ' + (hscale(d) / 2 + .5) + ' 0',
                            'scale': '.01 .01 .01',
                            'value': d
                        })
                })


            //__________________________Average bars__________________________


            // we scale the height of our bars using d3's linear scale
            hscale = d3.scale.linear()
                .domain([0, d3.max(avg_scores)])
                .range([0, 3])

            var bars = sheet1_B.selectAll("a-box.bar").data(avg_scores)
            bars.enter().append("a-box").classed("bar", true)

            $(".bar").append("<a-text> </a-text>");
            // we set attributes on our cubes to determine how they are rendered
            bars.attr({
                position: function (d, i) {
                    var x = i * .75
                    var y = hscale(d) / 2;
                    var z = 1
                    return x + " " + y + " " + z
                },
                width: function (d) { return 0.5 },
                depth: function (d) { return 0.5 },
                height: function (d) { return hscale(d) },
                opacity: alpha,
                color: 'blue'
            })
                .on("click", function (d, i) {
                    console.log("click", i, d)
                })
                .on("mouseenter", function (d, i) {
                    // this event gets fired continuously as long as the cursor
                    // is over the element. we only want trigger our animation the first time
                    if (this.hovering) return;
                    console.log("hover", i, d)
                    this.hovering = true;
                    d3.select(this).transition().duration(10)
                        .attr({
                            metalness: 0.8,
                            opacity: .9
                        })
                    d3.select(this).select("a-text")
                        .attr({
                            'color': 'hsla(240, 100%, 25%, 0.6)',
                            'align': 'center',
                            'position': '0 ' + (hscale(d) / 2 + .5) + ' 0',
                            'scale': '1 1 1',
                            'value': hotspots[i] + ', ' + d
                        })
                })
                .on("mouseleave", function (d, i) {
                    console.log("leave", i, d)
                    this.hovering = false;
                    d3.select(this).transition().duration(500)
                        .attr({
                            metalness: 0,
                            opacity: alpha
                        })
                    d3.select(this).select("a-text")
                        .attr({
                            'color': 'blue',
                            'align': 'center',
                            'position': '0 ' + (hscale(d) / 2 + .5) + ' 0',
                            'scale': '.01 .01 .01',
                            'value': d
                        })
                })




        }

        
        visualize_bars();

    </script>

    <script>

        $(".bar").each(function () {
            this.components.material.material.alphaTest = 0.5;
            this.components.material.material.depthWrite = false;
            this.components.material.material.needsUpdate = true;;
        });

    </script>

    <body>
</html>